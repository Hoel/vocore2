#define FBUSB_TYPE	"nt35510"

static const unsigned short boot[] = {
	0xf000, 0x0055, 0xf001, 0x00aa, 0xf002, 0x0052, 0xf003, 0x0008,
	0xf004, 0x0001,
	0xb000, 0x000d, 0xb001, 0x000d, 0xb002, 0x000d,
	0xb100, 0x000d, 0xb101, 0x000d, 0xb102, 0x000d,
	0xb200, 0x0000, 0xb201, 0x0000, 0xb202, 0x0000,
	0xb600, 0x0044, 0xb601, 0x0044, 0xb602, 0x0044,
	0xb700, 0x0034, 0xb701, 0x0034, 0xb702, 0x0034,
	0xb800, 0x0034, 0xb801, 0x0034, 0xb802, 0x0034,
	0xbf00, 0x0001,
	0xb300, 0x000f, 0xb301, 0x000f, 0xb302, 0x000f,
	0xb900, 0x0034, 0xb901, 0x0034, 0xb902, 0x0034,
	0xb500, 0x0008, 0xb501, 0x0008, 0xb502, 0x0008,
	0xc200, 0x0003,
	0xba00, 0x0034, 0xba01, 0x0034, 0xba02, 0x0034,
	0xbc00, 0x0000, 0xbc01, 0x0078, 0xbc02, 0x0000,
	0xbd00, 0x0000, 0xbd01, 0x0078, 0xbd02, 0x0000,
	0xbe00, 0x0000, 0xbe01, 0x0064,

	0xd100, 0x0000, 0xd101, 0x0033, 0xd102, 0x0000, 0xd103, 0x0034,
	0xd104, 0x0000, 0xd105, 0x003a, 0xd106, 0x0000, 0xd107, 0x004a,
	0xd108, 0x0000, 0xd109, 0x005c, 0xd10a, 0x0000, 0xd10b, 0x0081,
	0xd10c, 0x0000, 0xd10d, 0x00a6, 0xd10e, 0x0000, 0xd10f, 0x00e5,
	0xd110, 0x0001, 0xd111, 0x0013, 0xd112, 0x0001, 0xd113, 0x0054,
	0xd114, 0x0001, 0xd115, 0x0082, 0xd116, 0x0001, 0xd117, 0x00ca,
	0xd118, 0x0002, 0xd119, 0x0000, 0xd11a, 0x0002, 0xd11b, 0x0001,
	0xd11c, 0x0002, 0xd11d, 0x0034, 0xd11e, 0x0002, 0xd11f, 0x0067,
	0xd120, 0x0002, 0xd121, 0x0084, 0xd122, 0x0002, 0xd123, 0x00a4,
	0xd124, 0x0002, 0xd125, 0x00b7, 0xd126, 0x0002, 0xd127, 0x00cf,
	0xd128, 0x0002, 0xd129, 0x00de, 0xd12a, 0x0002, 0xd12b, 0x00f2,
	0xd12c, 0x0002, 0xd12d, 0x00fe, 0xd12e, 0x0003, 0xd12f, 0x0010,
	0xd130, 0x0003, 0xd131, 0x0033, 0xd132, 0x0003, 0xd133, 0x006d,

	0xd200, 0x0000, 0xd201, 0x0033, 0xd202, 0x0000, 0xd203, 0x0034,
	0xd204, 0x0000, 0xd205, 0x003a, 0xd206, 0x0000, 0xd207, 0x004a,
	0xd208, 0x0000, 0xd209, 0x005c, 0xd20a, 0x0000, 0xd20b, 0x0081,
	0xd20c, 0x0000, 0xd20d, 0x00a6, 0xd20e, 0x0000, 0xd20f, 0x00e5,
	0xd210, 0x0001, 0xd211, 0x0013, 0xd212, 0x0001, 0xd213, 0x0054,
	0xd214, 0x0001, 0xd215, 0x0082, 0xd216, 0x0001, 0xd217, 0x00ca,
	0xd218, 0x0002, 0xd219, 0x0000, 0xd21a, 0x0002, 0xd21b, 0x0001,
	0xd21c, 0x0002, 0xd21d, 0x0034, 0xd21e, 0x0002, 0xd21f, 0x0067,
	0xd220, 0x0002, 0xd221, 0x0084, 0xd222, 0x0002, 0xd223, 0x00a4,
	0xd224, 0x0002, 0xd225, 0x00b7, 0xd226, 0x0002, 0xd227, 0x00cf,
	0xd228, 0x0002, 0xd229, 0x00de, 0xd22a, 0x0002, 0xd22b, 0x00f2,
	0xd22c, 0x0002, 0xd22d, 0x00fe, 0xd22e, 0x0003, 0xd22f, 0x0010,
	0xd230, 0x0003, 0xd231, 0x0033, 0xd232, 0x0003, 0xd233, 0x006d,

	0xd300, 0x0000, 0xd301, 0x0033, 0xd302, 0x0000, 0xd303, 0x0034,
	0xd304, 0x0000, 0xd305, 0x003a, 0xd306, 0x0000, 0xd307, 0x004a,
	0xd308, 0x0000, 0xd309, 0x005c, 0xd30a, 0x0000, 0xd30b, 0x0081,
	0xd30c, 0x0000, 0xd30d, 0x00a6, 0xd30e, 0x0000, 0xd30f, 0x00e5,
	0xd310, 0x0001, 0xd311, 0x0013, 0xd312, 0x0001, 0xd313, 0x0054,
	0xd314, 0x0001, 0xd315, 0x0082, 0xd316, 0x0001, 0xd317, 0x00ca,
	0xd318, 0x0002, 0xd319, 0x0000, 0xd31a, 0x0002, 0xd31b, 0x0001,
	0xd31c, 0x0002, 0xd31d, 0x0034, 0xd31e, 0x0002, 0xd31f, 0x0067,
	0xd320, 0x0002, 0xd321, 0x0084, 0xd322, 0x0002, 0xd323, 0x00a4,
	0xd324, 0x0002, 0xd325, 0x00b7, 0xd326, 0x0002, 0xd327, 0x00cf,
	0xd328, 0x0002, 0xd329, 0x00de, 0xd32a, 0x0002, 0xd32b, 0x00f2,
	0xd32c, 0x0002, 0xd32d, 0x00fe, 0xd32e, 0x0003, 0xd32f, 0x0010,
	0xd330, 0x0003, 0xd331, 0x0033, 0xd332, 0x0003, 0xd333, 0x006d,

	0xd400, 0x0000, 0xd401, 0x0033, 0xd402, 0x0000, 0xd403, 0x0034,
	0xd404, 0x0000, 0xd405, 0x003a, 0xd406, 0x0000, 0xd407, 0x004a,
	0xd408, 0x0000, 0xd409, 0x005c, 0xd40a, 0x0000, 0xd40b, 0x0081,
	0xd40c, 0x0000, 0xd40d, 0x00a6, 0xd40e, 0x0000, 0xd40f, 0x00e5,
	0xd410, 0x0001, 0xd411, 0x0013, 0xd412, 0x0001, 0xd413, 0x0054,
	0xd414, 0x0001, 0xd415, 0x0082, 0xd416, 0x0001, 0xd417, 0x00ca,
	0xd418, 0x0002, 0xd419, 0x0000, 0xd41a, 0x0002, 0xd41b, 0x0001,
	0xd41c, 0x0002, 0xd41d, 0x0034, 0xd41e, 0x0002, 0xd41f, 0x0067,
	0xd420, 0x0002, 0xd421, 0x0084, 0xd422, 0x0002, 0xd423, 0x00a4,
	0xd424, 0x0002, 0xd425, 0x00b7, 0xd426, 0x0002, 0xd427, 0x00cf,
	0xd428, 0x0002, 0xd429, 0x00de, 0xd42a, 0x0002, 0xd42b, 0x00f2,
	0xd42c, 0x0002, 0xd42d, 0x00fe, 0xd42e, 0x0003, 0xd42f, 0x0010,
	0xd430, 0x0003, 0xd431, 0x0033, 0xd432, 0x0003, 0xd433, 0x006d,

	0xd500, 0x0000, 0xd501, 0x0033, 0xd502, 0x0000, 0xd503, 0x0034,
	0xd504, 0x0000, 0xd505, 0x003a, 0xd506, 0x0000, 0xd507, 0x004a,
	0xd508, 0x0000, 0xd509, 0x005c, 0xd50a, 0x0000, 0xd50b, 0x0081,
	0xd50c, 0x0000, 0xd50d, 0x00a6, 0xd50e, 0x0000, 0xd50f, 0x00e5,
	0xd510, 0x0001, 0xd511, 0x0013, 0xd512, 0x0001, 0xd513, 0x0054,
	0xd514, 0x0001, 0xd515, 0x0082, 0xd516, 0x0001, 0xd517, 0x00ca,
	0xd518, 0x0002, 0xd519, 0x0000, 0xd51a, 0x0002, 0xd51b, 0x0001,
	0xd51c, 0x0002, 0xd51d, 0x0034, 0xd51e, 0x0002, 0xd51f, 0x0067,
	0xd520, 0x0002, 0xd521, 0x0084, 0xd522, 0x0002, 0xd523, 0x00a4,
	0xd524, 0x0002, 0xd525, 0x00b7, 0xd526, 0x0002, 0xd527, 0x00cf,
	0xd528, 0x0002, 0xd529, 0x00de, 0xd52a, 0x0002, 0xd52b, 0x00f2,
	0xd52c, 0x0002, 0xd52d, 0x00fe, 0xd52e, 0x0003, 0xd52f, 0x0010,
	0xd530, 0x0003, 0xd531, 0x0033, 0xd532, 0x0003, 0xd533, 0x006d,

	0xd600, 0x0000, 0xd601, 0x0033, 0xd602, 0x0000, 0xd603, 0x0034,
	0xd604, 0x0000, 0xd605, 0x003a, 0xd606, 0x0000, 0xd607, 0x004a,
	0xd608, 0x0000, 0xd609, 0x005c, 0xd60a, 0x0000, 0xd60b, 0x0081,
	0xd60c, 0x0000, 0xd60d, 0x00a6, 0xd60e, 0x0000, 0xd60f, 0x00e5,
	0xd610, 0x0001, 0xd611, 0x0013, 0xd612, 0x0001, 0xd613, 0x0054,
	0xd614, 0x0001, 0xd615, 0x0082, 0xd616, 0x0001, 0xd617, 0x00ca,
	0xd618, 0x0002, 0xd619, 0x0000, 0xd61a, 0x0002, 0xd61b, 0x0001,
	0xd61c, 0x0002, 0xd61d, 0x0034, 0xd61e, 0x0002, 0xd61f, 0x0067,
	0xd620, 0x0002, 0xd621, 0x0084, 0xd622, 0x0002, 0xd623, 0x00a4,
	0xd624, 0x0002, 0xd625, 0x00b7, 0xd626, 0x0002, 0xd627, 0x00cf,
	0xd628, 0x0002, 0xd629, 0x00de, 0xd62a, 0x0002, 0xd62b, 0x00f2,
	0xd62c, 0x0002, 0xd62d, 0x00fe, 0xd62e, 0x0003, 0xd62f, 0x0010,
	0xd630, 0x0003, 0xd631, 0x0033, 0xd632, 0x0003, 0xd633, 0x006d,

	0xf000, 0x0055, 0xf001, 0x00aa, 0xf002, 0x0052, 0xf003, 0x0008,
	0xf004, 0x0000,

	0xb500, 0x0070,
	0xb100, 0x00cc, 0xb101, 0x0000,

	0xb600, 0x0005,
	0xb700, 0x0077, 0xb701, 0x0077,
	0xb800, 0x0001, 0xb801, 0x0003, 0xb802, 0x0003, 0xb803, 0x0003,
	0xbc00, 0x0002, 0xbc01, 0x0000, 0xbc02, 0x0000,
	0xbd00, 0x0001, 0xbd01, 0x0084, 0xbd02, 0x001c, 0xbd03, 0x001c,
	0xbd04, 0x0000,
	0xc900, 0x00d0, 0xc901, 0x0002, 0xc902, 0x0050, 0xc903, 0x0050,
	0xc904, 0x0050,
	0x3600, 0x0000,
	0x3500, 0x0000,

	0xff00, 0x00aa, 0xff01, 0x0055, 0xff02, 0x0025, 0xff03, 0x0001,
	0xfc00, 0x0016, 0xfc01, 0x00a2, 0xfc02, 0x0026,

	0x1100, 0x0000,
	0x5100, 0x00ff,
	0x5300, 0x0024,
	0x5500, 0x0002,
	0x2900, 0x0000,

	0x2a00, 0x0000, 0x2a01, 0x0000, 0x2a02, 0x0001, 0x2a03, 0x00df,
	0x2b00, 0x0000, 0x2b01, 0x0000, 0x2b02, 0x0003, 0x2b03, 0x001f,
	0x3a00, 0x0055,
};

inline void fbusb_load_logo(u8 *logo)
{
	u8 *buf = kmalloc(0x6000, GFP_KERNEL);
	int size, osize;

	if (buf == NULL)
		return;

	fbusb_data_uncompress(logo16, sizeof(logo16), buf, size);
	fbusb_data_uncompress(buf, size, logo, osize);
	kfree(buf);
}

static int fbusb_boot_setup(struct fbusb_info *uinfo)
{
	struct usb_device *udev;
	u8 *buf = NULL;
	int i, ret;

	udev = interface_to_usbdev(uinfo->interface);
	buf = kmalloc(FBUSB_SCREEN_BUFFER, GFP_KERNEL);
	if (buf == NULL) {
		ret = -ENOMEM;
		goto fbusb_boot_setup_error;
	}

	/* check if firmwall already installed */
	ret = usb_control_msg(udev, usb_rcvctrlpipe(udev, 0), 0xb4, 0xc0,
			      0, 0, buf, 1, FBUSB_MAX_DELAY);
	if (ret < 0 || buf[0] == 1)
		goto fbusb_boot_setup_error;

	buf[2] = 2;	/* size is always 2 */
	buf[3] = 0;
	buf[4] = 0;
	buf[5] = 0;
	buf[7] = 0;

	for (i = 0; i < sizeof(boot) / sizeof(*boot); i += 2) {
		buf[0] = boot[i];
		buf[1] = boot[i] >> 8;
		buf[6] = boot[i + 1];

		ret = usb_control_msg(udev, usb_sndctrlpipe(udev, 0), 0xb0, 0x40,
				      0, 0, buf, 8, FBUSB_MAX_DELAY);
		if (ret < 0)
			goto fbusb_boot_setup_error;
	}

	// send ready command.
	ret = usb_control_msg(udev, usb_sndctrlpipe(udev, 0), 0xb3, 0x40,
			      0, 0, NULL, 0, FBUSB_MAX_DELAY);

fbusb_boot_setup_error:
	kfree(buf);
	return ret;
}

static void fbusb_update_backlight(struct fbusb_info *uinfo)
{
	static u16 backlight;
	struct fbusb_par *par = uinfo->info->par;
	u8 *cmd;

	if (backlight == uinfo->backlight)
		return;
	backlight = uinfo->backlight;

	cmd = kzalloc(8, GFP_KERNEL);
	cmd[1] = 0x51;
	cmd[2] = 0x02;
	cmd[6] = (backlight * 255 + 50) / 100;
	usb_control_msg(par->udev, usb_sndctrlpipe(par->udev, 0), 0xb0, 0x40,
		0, 0, cmd, 8, FBUSB_MAX_DELAY);
	kfree(cmd);
}
